{{/*
  Single Habit Tracker Shortcode
  Usage: {{< habit-tracker-single csv="data/habits-2025.csv" year="2025" habit="reading" >}}
*/}}

{{ $csv := .Get "csv" }}
{{ $year := .Get "year" | default now.Year }}
{{ $habit := .Get "habit" }}
{{ $random := printf "%d%d" now.Unix now.Nanosecond }}
{{ $id := printf "habit-%s" $random }}

<div class="habit-tracker-simple" id="{{ $id }}">
  <style>
    /* Grid layouts - can't be replaced with Tachyons */
    #{{ $id }} .year-grid {
      display: grid;
      grid-template-rows: auto repeat(7, 1fr);
      gap: 2px;
      width: 100%;
    }
    #{{ $id }} .month-labels {
      display: grid;
      grid-auto-flow: column;
      gap: 2px;
    }
    #{{ $id }} .week-row {
      display: grid;
      grid-auto-flow: column;
      gap: 2px;
      align-items: center;
    }
    #{{ $id }} .months-grid-expanded {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    #{{ $id }} .weekday-labels {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    #{{ $id }} .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    #{{ $id }} .year-view .calendar-grid {
      gap: 1px;
    }
    #{{ $id }} .year-view .weekday-labels {
      display: none;
    }

    /* Day cell styles */
    #{{ $id }} .day-cell {
      aspect-ratio: 1;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
      background: #ebedf0;
      font-size: 10px;
      color: #666;
    }
    #{{ $id }} .year-view .day-cell {
      font-size: 0;
    }
    #{{ $id }} .day-cell.empty {
      background: transparent;
      cursor: default;
    }
    #{{ $id }} .day-cell.future {
      background: #f5f5f5;
      opacity: 0.5;
    }
    #{{ $id }} .day-cell[data-level="1"] { background: #c6e48b; color: #333; }
    #{{ $id }} .day-cell[data-level="2"] { background: #7bc96f; color: #333; }
    #{{ $id }} .day-cell[data-level="3"] { background: #239a3b; color: white; }
    #{{ $id }} .day-cell[data-level="4"] { background: #196127; color: white; }
    #{{ $id }} .day-cell:not(.empty):hover {
      outline: 2px solid #433a33;
      z-index: 10;
    }

    /* Button active state */
    #{{ $id }} .view-btn.active {
      background: #433a33;
      color: white;
      border-color: #433a33;
    }

    /* Tooltip */
    #{{ $id }} .tooltip {
      position: absolute;
      pointer-events: none;
      z-index: 1000;
      display: none;
      white-space: nowrap;
    }
  </style>

  <div id="{{ $id }}-container"></div>

  <div class="flex items-center mt4 f6 mid-gray">
    <span class="mr2">Less</span>
    <div class="w1 h1 br1 mr1" style="background: #ebedf0;"></div>
    <div class="w1 h1 br1 mr1" style="background: #c6e48b;"></div>
    <div class="w1 h1 br1 mr1" style="background: #7bc96f;"></div>
    <div class="w1 h1 br1 mr1" style="background: #239a3b;"></div>
    <div class="w1 h1 br1 mr2" style="background: #196127;"></div>
    <span>More</span>
  </div>

  <div class="tooltip dark-gray bg-white pa2 br2 f6 shadow-3 ba b--moon-gray" id="{{ $id }}-tooltip"></div>
</div>

<script>
(function() {
  const csvPath = '{{ $csv }}';
  const year = parseInt({{ $year }}, 10);
  const targetHabit = '{{ $habit }}';
  const container = document.getElementById('{{ $id }}-container');
  const tooltip = document.getElementById('{{ $id }}-tooltip');

  fetch(csvPath)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.text();
    })
    .then(csvText => {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',');
      const habits = headers.slice(1);

      // Find the target habit
      const habitIndex = habits.findIndex(h => h.trim().toLowerCase() === targetHabit.toLowerCase());
      if (habitIndex === -1) {
        container.innerHTML = `<div class="dark-red pa3 bg-washed-red br2">Habit "${targetHabit}" not found in CSV</div>`;
        return;
      }

      const habitData = {};
      lines.slice(1).forEach(line => {
        const parts = line.split(',').map(p => p.trim());
        const date = parts[0];
        habitData[date] = parts[habitIndex + 1];
      });

      renderHabit(targetHabit, habitData);
    })
    .catch(error => {
      container.innerHTML = `<div class="dark-red pa3 bg-washed-red br2">Error loading habit data: ${error.message}</div>`;
    });

  function renderHabit(habitName, habitData) {
    const section = document.createElement('div');
    section.className = 'mb4';

    const total = Object.keys(habitData).length;
    const completed = Object.values(habitData).filter(v => v === '1').length;
    const rate = Math.round((completed / total) * 100);

    const habitId = habitName.replace(/[^a-z0-9]/gi, '-');

    section.innerHTML = `
      <div class="f4 fw6 dark-gray mb2">${habitName.charAt(0).toUpperCase() + habitName.slice(1)}</div>
      <div class="flex gap3 mb3 f6 mid-gray">
        <span><span class="fw6 dark-gray">${completed}/${total}</span> days</span>
        <span class="ml3"><span class="fw6 dark-gray">${rate}%</span> completion</span>
      </div>
      <div class="flex gap2 mb3">
        <button class="view-btn active ph3 pv2 ba b--moon-gray bg-white br2 pointer f6 mid-gray" data-view="year">Year View</button>
        <button class="view-btn ph3 pv2 ba b--moon-gray bg-white br2 pointer f6 mid-gray" data-view="monthly">Monthly View</button>
      </div>
      <div id="view-container-${habitId}"></div>
    `;

    container.appendChild(section);

    const viewContainer = section.querySelector(`#view-container-${habitId}`);
    const viewBtns = section.querySelectorAll('.view-btn');

    // Render initial year view
    renderYearView(viewContainer, habitData);

    // Add view toggle functionality
    viewBtns.forEach(btn => {
      btn.addEventListener('mouseenter', function() {
        if (!this.classList.contains('active')) {
          this.classList.add('bg-near-white');
        }
      });
      btn.addEventListener('mouseleave', function() {
        this.classList.remove('bg-near-white');
      });

      btn.addEventListener('click', function() {
        viewBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        const view = this.dataset.view;
        viewContainer.innerHTML = '';

        if (view === 'year') {
          renderYearView(viewContainer, habitData);
        } else {
          renderMonthlyView(viewContainer, habitData);
        }
      });
    });
  }

  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function renderYearView(container, habitData) {
    const yearDiv = document.createElement('div');
    yearDiv.className = 'year-view mt2';

    const yearGrid = document.createElement('div');
    yearGrid.className = 'year-grid';

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const weekdayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    // Create all dates for the year
    const startDate = new Date(year, 0, 1);
    const endDate = new Date(year, 11, 31);

    // Find the first Monday before or on Jan 1
    const firstMonday = new Date(startDate);
    const dayOfWeek = firstMonday.getDay();
    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    firstMonday.setDate(firstMonday.getDate() - daysToMonday);

    // Calculate number of weeks
    const lastDate = new Date(endDate);
    const weeks = Math.ceil((lastDate - firstMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;

    // Create array of all days organized by week and day of week
    const calendar = Array(7).fill(null).map(() => []);
    let currentDate = new Date(firstMonday);

    for (let week = 0; week < weeks; week++) {
      for (let day = 0; day < 7; day++) {
        const dayOfWeek = currentDate.getDay();
        const calendarIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        calendar[calendarIndex].push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
      }
    }

    // Create month labels row
    const monthLabelsRow = document.createElement('div');
    monthLabelsRow.style.display = 'grid';
    monthLabelsRow.style.gridAutoFlow = 'column';
    monthLabelsRow.style.gap = '2px';
    monthLabelsRow.style.marginBottom = '4px';
    monthLabelsRow.style.marginLeft = '38px';

    let currentMonth = -1;
    calendar[0].forEach((date, weekIndex) => {
      if (date.getFullYear() === year && date.getMonth() !== currentMonth) {
        currentMonth = date.getMonth();
        const monthSpan = document.createElement('span');
        monthSpan.className = 'f7 fw6 dark-gray tl ph1';
        monthSpan.textContent = monthNames[currentMonth];
        monthSpan.style.gridColumn = `${weekIndex + 1}`;
        monthLabelsRow.appendChild(monthSpan);
      }
    });

    yearGrid.appendChild(monthLabelsRow);

    // Create rows for each day of week
    weekdayLabels.forEach((dayLabel, dayIndex) => {
      const row = document.createElement('div');
      row.className = 'week-row';

      const label = document.createElement('div');
      label.className = 'f7 silver pr2 tr';
      label.style.minWidth = '30px';
      label.textContent = dayLabel;
      row.appendChild(label);

      calendar[dayIndex].forEach(date => {
        const dateStr = formatDate(date);
        const value = habitData[dateStr];
        const isCurrentYear = date.getFullYear() === year;
        const isFuture = date > new Date();

        const cell = document.createElement('div');
        cell.className = 'day-cell';

        if (!isCurrentYear) {
          cell.classList.add('empty');
        } else if (isFuture) {
          cell.classList.add('future');
        } else {
          const level = value === '1' ? '4' : '0';
          cell.setAttribute('data-level', level);
        }

        cell.setAttribute('data-date', dateStr);
        cell.setAttribute('data-value', value || '0');

        if (isCurrentYear && !isFuture) {
          cell.addEventListener('mouseenter', function(e) {
            const status = value === '1' ? '✓ Completed' : '✗ Missed';
            tooltip.textContent = `${dateStr}: ${status}`;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY - 10) + 'px';
          });

          cell.addEventListener('mouseleave', function() {
            tooltip.style.display = 'none';
          });
        }

        row.appendChild(cell);
      });

      yearGrid.appendChild(row);
    });

    yearDiv.appendChild(yearGrid);
    container.appendChild(yearDiv);
  }

  function renderMonthlyView(container, habitData) {
    const monthsDiv = document.createElement('div');
    monthsDiv.className = 'months-grid months-grid-expanded mt2';

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
    const weekdayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    // Create 12 monthly calendars
    for (let month = 0; month < 12; month++) {
      const monthContainer = document.createElement('div');
      monthContainer.className = 'bg-near-white pa3 br2';

      const monthHeader = document.createElement('div');
      monthHeader.className = 'f5 fw6 dark-gray tc mb2';
      monthHeader.textContent = monthNames[month];
      monthContainer.appendChild(monthHeader);

      // Add weekday labels
      const weekdayRow = document.createElement('div');
      weekdayRow.className = 'weekday-labels mb1';
      weekdayLabels.forEach(day => {
        const label = document.createElement('div');
        label.className = 'f7 fw6 silver tc pa1';
        label.textContent = day;
        weekdayRow.appendChild(label);
      });
      monthContainer.appendChild(weekdayRow);

      // Create calendar grid
      const grid = document.createElement('div');
      grid.className = 'calendar-grid';

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      // Convert to Monday-first (0=Mon, 6=Sun)
      const startingDayMonFirst = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;

      // Add empty cells for days before month starts
      for (let i = 0; i < startingDayMonFirst; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'day-cell empty';
        grid.appendChild(emptyCell);
      }

      // Add cells for each day of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = formatDate(date);
        const value = habitData[dateStr];
        const level = value === '1' ? '4' : '0';

        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.setAttribute('data-level', level);
        cell.setAttribute('data-date', dateStr);
        cell.setAttribute('data-value', value || '0');
        cell.textContent = day;

        cell.addEventListener('mouseenter', function(e) {
          const status = value === '1' ? '✓ Completed' : '✗ Missed';
          tooltip.textContent = `${dateStr}: ${status}`;
          tooltip.style.display = 'block';
          tooltip.style.left = (e.pageX + 10) + 'px';
          tooltip.style.top = (e.pageY - 10) + 'px';
        });

        cell.addEventListener('mouseleave', function() {
          tooltip.style.display = 'none';
        });

        grid.appendChild(cell);
      }

      monthContainer.appendChild(grid);
      monthsDiv.appendChild(monthContainer);
    }

    container.appendChild(monthsDiv);
  }
})();
</script>
</div>